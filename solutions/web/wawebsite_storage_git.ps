<#
.SYNOPSIS
    Creates scheduled tasks to Manage Windows Azure Websites
.DESCRIPTION
    Operations TBD
    Load your publishSettings (Maybe set default if it has more than one)
    Check if the website already exists 
    Create the website 
    Run the website
    
    Is important that you run this script in the same location you have the files of your website
    `
.EXAMPLE
    WAzure_Websites_Storage.ps1 -defaultsuscription "MySubscrName" -websitename "WebSiteName" -storageName ""
#>


param(
         
    # The webSite Name you want to create.
    [Parameter(Mandatory = $true)] 
    [string]$websitename,

    # The WebSiteLocation. 
    [Parameter(Mandatory = $true)] 
    [string]$websitelocation,

    # The StorageAccountName
    [Parameter(Mandatory = $true)]
    [String]$storageName,
   

    # The name of the RemoreGit to Use. 
    [Parameter(Mandatory = $true)]
    [string]$gitremoteurl
        
    )



# The script has been tested on Powershell 3.0
Set-StrictMode -Version 3


# Following modifies the Write-Verbose behavior to turn the messages on globally for this session
#$VerbosePreference = "Continue" 


Write-Verbose ("Some Verifications... ")


#ENVIRONMENT
# Check if Windows Azure Powershell is avaiable
if ((Get-Module Azure) -eq $null)
{
    throw "Windows Azure Powershell not found! Please make sure to install them from http://www.windowsazure.com/en-us/downloads/#cmd-line-tools"
}




#WEBSITE
#Check if the Website exists 
$result = Get-AzureWebsite | Where-Object {$_.Name -eq "cn2p" }

if($result -eq $null) {Write-Verbose "creating website" }

else 
{
    Write-Error "Error the site already exist, Maybe  you want to Update it"
    exit
}



#Start Creation 
Write-Verbose ("Starting Website {0} Create process" -f $websitename)
$website = New-AzureWebsite -Name $websitename -Location $websitelocation -Verbose


#Show Website  
#Write-Verbose ("Run the website!" -f $websitename)
#Show-AzureWebsite $websitename


#STORAGE
# Create a new storage account
Write-Verbose ("[Start] creating storage account {0} in location {1}" -f $storageName, $websitelocation)

#We will need to add verification to see if the storage account already exist, similar to the Website 

New-AzureStorageAccount -StorageAccountName $storageName -Location $websitelocation -Verbose
Write-Verbose ("[Finish] creating storage account {0} in location {1}" -f $storageName, $websitelocation)


# Get the access key of the storage account
$key = Get-AzureStorageKey -StorageAccountName $storageName


# Generate the connection string of the storage account
$connectionString = "BlobEndpoint=http://{0}.blob.core.windows.net/;QueueEndpoint=http://{0}.queue.core.windows.net/;TableEndpoint=http://{0}.table.core.windows.net/;AccountName={0};AccountKey={1}" -f $Name, $key.Primary


#Execute the following if you need to get some vars info
#Return @{AccountName = $storageName; AccessKey = $key.Primary; ConnectionString = $connectionString}


#SQL
# Lutfull 

#GIT
git init
git add .
git commit -m "changing Site PS"
#git remote add azure $gitremoteurl
git config --global user.name "Your Name Here" 
git config --global user.password "Your Pass Here" 
git push azure master
Write-Verbose "Published!" 
